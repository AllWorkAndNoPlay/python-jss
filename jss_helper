#!/usr/bin/python
"""jss_helper

Command line utility using jss.py

Shea Craig 2014

"""

import argparse

import requests.exceptions

from jss import *


def print_object(objs):
    if isinstance(objs, list):
        for obj in objs:
            print("ID: %s\tNAME: %s" % (obj.id(), obj.name()))
    else:
        objs.pprint()


def get_policy(j, args):
    """Helper function."""
    if args.id:
        results = j.Policy(args.id)
    else:
        results = j.Policy()
    print_object(results)


def get_group_policies(j, args):
    """Helper function."""
    results = []
    for p in j.Policy():
        px = None
        while px is None:
            try:
                px = j.Policy(p.id())
                search = 'scope/computer_groups/computer_group'
                for computer_group in px.xml.findall(search):
                    if computer_group.findtext('name') == args.group:
                        results.append((p.id(), p.name()))
            except requests.exceptions.SSLError as e:
                print("Failed... Trying again in a moment.")

    print("Policies in scope for %s:" % args.group)
    for i in results:
        print("ID: %s\t\tNAME: %s" % (i[0], i[1]))


#def get_group_policies(args):
#    """Helper function."""
#    results = get_policies_scoped_to_computer_group(args.group)
#    print("Results:")
#    for result in results:
#        pprint(result[0])
#        pprint(result[1])
#
#
#def policy(args):
#    """Helper function."""
#    result = get_policy_by_id(args.id)
#    pprint(result)
#
#
#def policy_by_name(args):
#    """Helper function."""
#    result = get_policy_by_name(args.name)
#    pprint(result)
#
#
#def md_configps(args):
#    """Helper function."""
#    result = get_md_configps()
#    pprint(result)
#
#
#def md_configp(args):
#    """Helper function."""
#    result = get_configp_by_id(args.id)
#    pprint(result)
#
#
#def md_configp_group(args):
#    """Helper function."""
#    results = get_md_configp_scoped_to_group(args.group)
#    print("Results:")
#    for result in results:
#        pprint(result[0])
#        pprint(result[1])


def main():
    """Run as a cli command."""

    jss_prefs = JSSPrefs()
    j = JSS(jss_prefs)

    # Create our argument parser
    parser = argparse.ArgumentParser(description="Query the JSS.")
    subparser = parser.add_subparsers(dest='subparser_name')

    # get_policy
    help = "Get a list of all policies names and ids or the policy XML. "
    subparser_policy = subparser.add_parser('policy', help=help)
    subparser_policy.add_argument('-id', help="ID of policy to retrieve.")
    subparser_policy.set_defaults(func=get_policy)

    # policy_by_group
    help = "Lists all policies scoped to provided group."
    subparser_policy_by_group = subparser.add_parser('policy_by_group',
                                                     help=help)
    subparser_policy_by_group.add_argument('group', help="Group name to query.")
    subparser_policy_by_group.set_defaults(func=get_group_policies)

    ## md_configps
    #help = "Get a list of all mobile device configuration profiles, and " \
    #        "their IDs."
    #subparser_md_configps = subparser.add_parser('md_configps', help=help)
    #subparser_md_configps.set_defaults(func=md_configps)

    ## md_configp
    #help = "Get a mobile device configuration profile by ID."
    #subparser_md_configp = subparser.add_parser('md_configp', help=help)
    #subparser_md_configp.add_argument('id', help="ID of policy to retrieve.")
    #subparser_md_configp.set_defaults(func=md_configp)

    ## md_config_by_group
    #help = "List all configuration profiles scoped to group"
    #subparser_md_configp_by_group = subparser.add_parser('md_configp_by_group',
    #                                            help=help)
    #subparser_md_configp_by_group.add_argument('group',
    #                                           help="Group name to query.")
    #subparser_md_configp_by_group.set_defaults(func=md_configp_group)

    # Parse the args and then call their target function
    args = parser.parse_args()
    args.func(j, args)


if __name__ == '__main__':
    main()
